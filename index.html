<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CityVoice ‚Äì Cluj Report Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="app">
    <!-- LEFT: Map -->
    <div id="map"></div>

    <!-- RIGHT: Report panel -->
    <aside class="panel">
      <h2>Report a city problem</h2>
      <p>
        1) Choose category + add details + photos<br>
        2) Click the map to pick a location (draft)<br>
        3) Press <strong>Save report</strong> to place a permanent pin üìç<br>
        Saved pins persist using <strong>IndexedDB</strong> (no backend).
      </p>

      <div class="card">
        <label for="category">Problem category</label>
        <select id="category">
          <option value="Pothole">Pothole</option>
          <option value="Broken pavement / sidewalk">Broken pavement / sidewalk</option>
          <option value="Streetlight not working">Streetlight not working</option>
          <option value="Graffiti / vandalism">Graffiti / vandalism</option>
          <option value="Fly-tipping / illegal dumping">Fly-tipping / illegal dumping</option>
          <option value="Blocked drain / flooding">Blocked drain / flooding</option>
          <option value="Damaged road sign / markings">Damaged road sign / markings</option>
          <option value="Abandoned vehicle">Abandoned vehicle</option>
          <option value="Overgrown vegetation">Overgrown vegetation</option>
          <option value="Waste bin issue">Waste bin issue</option>
          <option value="Noise / disturbance">Noise / disturbance</option>
          <option value="Stray animals / animal issue">Stray animals / animal issue</option>
        </select>

        <label for="notes">Description (optional)</label>
        <textarea id="notes" placeholder="What happened? Landmarks? When did you notice it?"></textarea>

        <label for="photos">Attach up to 3 photos</label>
        <input id="photos" type="file" accept="image/*" multiple>

        <div class="photo-grid" aria-label="Photo previews">
          <div class="photo-slot">
            <img id="preview1" alt="Photo preview 1">
            <span id="label1">Photo 1</span>
          </div>
          <div class="photo-slot">
            <img id="preview2" alt="Photo preview 2">
            <span id="label2">Photo 2</span>
          </div>
          <div class="photo-slot">
            <img id="preview3" alt="Photo preview 3">
            <span id="label3">Photo 3</span>
          </div>
        </div>
 
        <div class="subcard">
          <div class="subcard-title">Contact details (optional)</div>
          <div class="small">
            Your contact details are stored privately (for municipal staff). They are never shown publicly unless you choose otherwise.
          </div>

          <label for="reporterName">Name (optional)</label>
          <input id="reporterName" type="text" placeholder="Your name">

          <label for="reporterEmail">Email (optional)</label>
          <input id="reporterEmail" type="email" placeholder="name@example.com">

          <label for="reporterPhone">Phone (optional)</label>
          <input id="reporterPhone" type="tel" placeholder="+40...">

          <label class="checkbox-row">
            <input id="publicAnonymous" type="checkbox" checked>
            Show publicly as anonymous (recommended)
          </label>
        </div>

        <div class="actions">
          <button id="saveBtn" class="primary" type="button">Save report</button>
          <button id="clearBtn" class="secondary" type="button">Clear draft</button>
          <button id="clearAllBtn" class="ghost" type="button">Clear ALL saved</button>
        </div>

        <div id="status" class="status">
          Click the map to choose a location for your report (draft). Then press Save report.
        </div>

        <div class="hint">
          Tip: Use the search bar on the map to find an address (Cluj-Napoca only).
        </div>
      </div>

      <div class="card">
        <div class="small"><strong>Draft vs Saved:</strong></div>
        <hr>
        <div class="small">‚Ä¢ Clicking the map only updates the <strong>draft</strong> location.</div>
        <div class="small">‚Ä¢ Only <strong>Save report</strong> creates a permanent pin.</div>
        <div class="small">‚Ä¢ Saved pins reload after refresh via <strong>IndexedDB</strong>.</div>
      </div>

      <div class="small">
        (Storage is local to your browser/device. Clearing browser data removes it.)
      </div>
    </aside>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
     
    const DB_NAME = "cityvoice_db";
    const DB_VERSION = 1;
    const STORE = "reports";

    function openDb() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);

        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)) {
            db.createObjectStore(STORE, { keyPath: "id" });
          }
        };

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function idbPut(db, value) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        tx.objectStore(STORE).put(value);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    function idbGetAll(db) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const req = tx.objectStore(STORE).getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    function idbClear(db) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const req = tx.objectStore(STORE).clear();
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    function makeId() {
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
    }

    // MAP OF CLUJ

    const map = L.map("map").setView([46.7712, 23.6236], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);
 
    // Geocoder (Cluj-only) 

    let searchMarker = null;

    const geocoderControl = L.Control.geocoder({
      defaultMarkGeocode: false
    }).addTo(map);

    geocoderControl.on("markgeocode", function (e) {
      const g = e.geocode;
      const label = (g && g.name) ? String(g.name) : "";
      const lower = label.toLowerCase();

      const ok =
        lower.includes("cluj-napoca") ||
        lower.includes("cluj napoca") ||
        lower.includes("municipiul cluj-napoca");

      if (!ok) {
        alert("Only Cluj-Napoca locations allowed.");
        return;
      }

      const center = g.center;

      if (searchMarker) map.removeLayer(searchMarker);
      searchMarker = L.marker(center).addTo(map).bindPopup(label);

      map.flyTo(center, 17);
      searchMarker.openPopup();
    });
 
    const categoryEl = document.getElementById("category");
    const notesEl = document.getElementById("notes");
    const photosEl = document.getElementById("photos");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const statusEl = document.getElementById("status");
 
    const reporterNameEl = document.getElementById("reporterName");
    const reporterEmailEl = document.getElementById("reporterEmail");
    const reporterPhoneEl = document.getElementById("reporterPhone");
    const publicAnonymousEl = document.getElementById("publicAnonymous");

    const previewEls = [
      { img: document.getElementById("preview1"), label: document.getElementById("label1") },
      { img: document.getElementById("preview2"), label: document.getElementById("label2") },
      { img: document.getElementById("preview3"), label: document.getElementById("label3") },
    ];

    let draftLatLng = null;
    let draftMarker = null;

    let selectedFiles = [];
    let previewUrls = [];
    let db = null;

    const savedMarkers = [];
 
    photosEl.addEventListener("change", async () => {
      const files = Array.from(photosEl.files || []);

      for (const file of files) {
        if (selectedFiles.length >= 3) break;
        selectedFiles.push(file);
        const url = URL.createObjectURL(file);
        previewUrls.push(url);
        setPreview(selectedFiles.length - 1, url);
      }

      photosEl.value = "";
    });

    function resetPreviews() {
      for (const u of previewUrls) URL.revokeObjectURL(u);
      previewUrls = [];

      previewEls.forEach((slot, idx) => {
        slot.img.src = "";
        slot.img.style.display = "none";
        slot.label.style.display = "block";
        slot.label.textContent = `Photo ${idx + 1}`;
      });
    }

    function setPreview(index, url) {
      const slot = previewEls[index];
      slot.img.src = url;
      slot.img.style.display = "block";
      slot.label.style.display = "none";
    }

    // =========================
    // click map = draft location only 
    map.on("click", (e) => {
      draftLatLng = e.latlng;

      if (!draftMarker) {
        draftMarker = L.marker(draftLatLng, { opacity: 0.7 }).addTo(map);
      } else {
        draftMarker.setLatLng(draftLatLng);
      }

      setStatus(
        `Draft location selected: Lat ${draftLatLng.lat.toFixed(5)}, Lng ${draftLatLng.lng.toFixed(5)}. Now press Save report.`,
        "ok"
      );
    });

    // =========================
    // Save report (IndexedDB + marker) 
    saveBtn.addEventListener("click", async () => {
      if (!draftLatLng) {
        setStatus("Pick a location first: click the map to set a draft pin.", "bad");
        return;
      }
      if (!db) {
        setStatus("Database not ready yet. Refresh the page.", "bad");
        return;
      }

      const reporterName = (reporterNameEl.value || "").trim();
      const reporterEmail = (reporterEmailEl.value || "").trim();
      const reporterPhone = (reporterPhoneEl.value || "").trim();
      const publicAnonymous = !!publicAnonymousEl.checked;

      const report = {
        id: makeId(),
        lat: draftLatLng.lat,
        lng: draftLatLng.lng,
        category: categoryEl.value,
        notes: (notesEl.value || "").trim(),
        createdAt: Date.now(),
        photos: selectedFiles.slice(0, 3),

        // NEW: private contact details stored with report
        contact: {
          name: reporterName,
          email: reporterEmail,
          phone: reporterPhone,
          publicAnonymous
        }
      };

      try {
        await idbPut(db, report);
        placeSavedMarker(report);

        clearDraftOnly();
 
        notesEl.value = "";
        selectedFiles = [];
        resetPreviews();
 
        reporterNameEl.value = "";
        reporterEmailEl.value = "";
        reporterPhoneEl.value = "";
        publicAnonymousEl.checked = true;

        setStatus("Report saved ‚úÖ Public map stays anonymous. Details stored privately.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Failed to save report (IndexedDB error). Check console.", "bad");
      }
    });

    clearBtn.addEventListener("click", () => {
      clearDraftOnly();
      notesEl.value = "";
      selectedFiles = [];
      resetPreviews();

      reporterNameEl.value = "";
      reporterEmailEl.value = "";
      reporterPhoneEl.value = "";
      publicAnonymousEl.checked = true;

      setStatus("Draft cleared. Click the map to choose a new draft location.", "");
    });

    function clearDraftOnly() {
      if (draftMarker) {
        map.removeLayer(draftMarker);
        draftMarker = null;
      }
      draftLatLng = null;
    }

    clearAllBtn.addEventListener("click", async () => {
      if (!db) return;
      if (!confirm("This will remove ALL saved reports from this browser. Continue?")) return;

      try {
        await idbClear(db);
        while (savedMarkers.length) {
          const m = savedMarkers.pop();
          map.removeLayer(m);
        }
        setStatus("All saved reports cleared ‚úÖ", "ok");
      } catch (err) {
        console.error(err);
        setStatus("Failed to clear saved reports (IndexedDB error).", "bad");
      }
    });

    // =========================
    // render saved reports 
    function placeSavedMarker(report) {
      const popupHtml = buildPopupHtmlPublic(report);
      const marker = L.marker([report.lat, report.lng]).addTo(map).bindPopup(popupHtml);
      savedMarkers.push(marker);
    }

    //never show email/phone. show name only if NOT anonymous.
    function buildPopupHtmlPublic(report) {
      const notes = report.notes ? `<div style="margin-bottom:6px;">${escapeHtml(report.notes)}</div>` : "";

      const contact = report.contact || {};
      const isAnon = contact.publicAnonymous !== false; // default to anonymous
      const publicReporterLine =
        (!isAnon && contact.name)
          ? `<div style="color:#666;font-size:12px;margin-bottom:6px;">Reported by: ${escapeHtml(contact.name)}</div>`
          : `<div style="color:#666;font-size:12px;margin-bottom:6px;">Reported anonymously</div>`;

      let thumbs = `<div style="margin-top:8px;color:#666;font-size:12px;">No photos attached.</div>`;
      if (report.photos && report.photos.length) {
        const imgs = report.photos.slice(0, 3).map((blob) => {
          const url = URL.createObjectURL(blob);
          return `<img src="${url}" alt="Report photo"
            style="width:100%;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee;">`;
        }).join("");
        thumbs = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px;">${imgs}</div>`;
      }

      const dateStr = new Date(report.createdAt).toLocaleString();

      return `
        <div style="min-width:240px;">
          <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(report.category)}</div>
          ${publicReporterLine}
          ${notes}
          <div style="color:#666;font-size:12px;">
            Saved: ${escapeHtml(dateStr)}<br>
            Lat: ${Number(report.lat).toFixed(5)}<br>
            Lng: ${Number(report.lng).toFixed(5)}
          </div>
          ${thumbs}
        </div>
      `;
    }

    function setStatus(text, tone) {
      statusEl.textContent = text;
      statusEl.classList.remove("ok", "bad");
      if (tone === "ok") statusEl.classList.add("ok");
      if (tone === "bad") statusEl.classList.add("bad");
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
 
    (async function boot() {
      try {
        db = await openDb();
        const reports = await idbGetAll(db);
        for (const r of reports) placeSavedMarker(r);
        setStatus(`Loaded ${reports.length} saved report(s) from IndexedDB ‚úÖ`, "ok");
      } catch (err) {
        console.error(err);
        setStatus("Failed to open IndexedDB. Check console.", "bad");
      }
      resetPreviews();
    })();
  </script>
</body>
</html>
