<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CityVoice ‚Äì Cluj Report Map</title>
 
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="app">
    <!-- LEFT: Map -->
    <div id="map"></div>

    <!-- RIGHT: Report panel -->
    <aside class="panel">
      <h2>Report a city problem</h2>
      <p>
        1) Choose category + add details + photos<br>
        2) Click the map to pick a location (draft)<br>
        3) Press <strong>Save report</strong> to place the real pin üìç
      </p>

      <div class="card">
        <label for="category">Problem category</label>
        <select id="category">
          <option value="Pothole">Pothole</option>
          <option value="Broken pavement / sidewalk">Broken pavement / sidewalk</option>
          <option value="Streetlight not working">Streetlight not working</option>
          <option value="Graffiti / vandalism">Graffiti / vandalism</option>
          <option value="Fly-tipping / illegal dumping">Fly-tipping / illegal dumping</option>
          <option value="Blocked drain / flooding">Blocked drain / flooding</option>
          <option value="Damaged road sign / markings">Damaged road sign / markings</option>
          <option value="Abandoned vehicle">Abandoned vehicle</option>
          <option value="Overgrown vegetation">Overgrown vegetation</option>
          <option value="Waste bin issue">Waste bin issue</option>
          <option value="Noise / disturbance">Noise / disturbance</option>
          <option value="Stray animals / animal issue">Stray animals / animal issue</option>
        </select>

        <label for="notes">Description (optional)</label>
        <textarea id="notes" placeholder="What happened? Landmarks? When did you notice it?"></textarea>

        <label for="photos">Attach up to 3 photos</label>
        <input id="photos" type="file" accept="image/*" multiple>

        <div class="photo-grid" aria-label="Photo previews">
          <div class="photo-slot">
            <img id="preview1" alt="Photo preview 1">
            <span id="label1">Photo 1</span>
          </div>
          <div class="photo-slot">
            <img id="preview2" alt="Photo preview 2">
            <span id="label2">Photo 2</span>
          </div>
          <div class="photo-slot">
            <img id="preview3" alt="Photo preview 3">
            <span id="label3">Photo 3</span>
          </div>
        </div>

        <div class="actions">
          <button id="saveBtn" class="primary" type="button">Save report</button>
          <button id="clearBtn" class="secondary" type="button">Clear draft</button>
        </div>

        <div id="status" class="status">
          Click the map to choose a location for your report (draft). Then press Save report.
        </div>

        <div class="hint">
          Tip: Use the search bar on the map to find an address (Cluj-Napoca only).
        </div>
      </div>

      <div class="card">
        <div class="small"><strong>Draft vs Saved:</strong></div>
        <hr>
        <div class="small">‚Ä¢ Clicking the map only updates the <strong>draft</strong> location.</div>
        <div class="small">‚Ä¢ Only <strong>Save report</strong> creates a permanent pin.</div>
      </div>

      <div class="small">
        (Still no backend ‚Äî saved pins remain while the page is open.)
      </div>
    </aside>
  </div>
 
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
  
    // map of cluj 
    const map = L.map("map").setView([46.7712, 23.6236], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    let searchMarker = null;

    const geocoderControl = L.Control.geocoder({
      defaultMarkGeocode: false
    }).addTo(map);

    geocoderControl.on("markgeocode", function (e) {
      const g = e.geocode;
      const label = (g && g.name) ? String(g.name) : "";
      const lower = label.toLowerCase();

      const ok =
        lower.includes("cluj-napoca") ||
        lower.includes("cluj napoca") ||
        lower.includes("municipiul cluj-napoca");

      if (!ok) {
        alert("Only Cluj-Napoca locations allowed.");
        return;
      }

      const center = g.center;

      if (searchMarker) map.removeLayer(searchMarker);
      searchMarker = L.marker(center).addTo(map).bindPopup(label);

      map.flyTo(center, 17);
      searchMarker.openPopup();
    });

    const categoryEl = document.getElementById("category");
    const notesEl = document.getElementById("notes");
    const photosEl = document.getElementById("photos");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusEl = document.getElementById("status");

    const previewEls = [
      { img: document.getElementById("preview1"), label: document.getElementById("label1") },
      { img: document.getElementById("preview2"), label: document.getElementById("label2") },
      { img: document.getElementById("preview3"), label: document.getElementById("label3") },
    ];
 
    let draftLatLng = null;
    let draftMarker = null;
 
    let selectedImageDataUrls = [];
 
    photosEl.addEventListener("change", async () => {
      const files = Array.from(photosEl.files || []);

      for (const file of files) {
        if (selectedImageDataUrls.length >= 3) break;

        const dataUrl = await fileToDataUrl(file);
        selectedImageDataUrls.push(dataUrl);
        setPreview(selectedImageDataUrls.length - 1, dataUrl);
      }
 
      photosEl.value = "";
    });

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function resetPreviews() {
      previewEls.forEach((slot, idx) => {
        slot.img.src = "";
        slot.img.style.display = "none";
        slot.label.style.display = "block";
        slot.label.textContent = `Photo ${idx + 1}`;
      });
    }

    function setPreview(index, dataUrl) {
      const slot = previewEls[index];
      slot.img.src = dataUrl;
      slot.img.style.display = "block";
      slot.label.style.display = "none";
    }
 
    map.on("click", (e) => {
      draftLatLng = e.latlng;
 
      if (!draftMarker) {
        draftMarker = L.marker(draftLatLng, { opacity: 0.7 }).addTo(map);
      } else {
        draftMarker.setLatLng(draftLatLng);
      }

      setStatus(
        `Draft location selected: Lat ${draftLatLng.lat.toFixed(5)}, Lng ${draftLatLng.lng.toFixed(5)}. Now press Save report.`,
        "ok"
      );
    });

     
    saveBtn.addEventListener("click", () => {
      if (!draftLatLng) {
        setStatus("Pick a location first: click on the map to set a draft pin.", "bad");
        return;
      }

      const category = categoryEl.value;
      const notes = (notesEl.value || "").trim();

      const thumbsHtml = selectedImageDataUrls.length
        ? `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px;">
            ${selectedImageDataUrls.map(src =>
              `<img src="${src}" alt="Report photo" style="width:100%;height:60px;object-fit:cover;border-radius:8px;border:1px solid #eee;">`
            ).join("")}
          </div>`
        : `<div style="margin-top:8px;color:#666;font-size:12px;">No photos attached.</div>`;

      const popupHtml = `
        <div style="min-width:220px;">
          <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(category)}</div>
          ${notes ? `<div style="margin-bottom:6px;">${escapeHtml(notes)}</div>` : ""}
          <div style="color:#666;font-size:12px;">
            Lat: ${draftLatLng.lat.toFixed(5)}<br>
            Lng: ${draftLatLng.lng.toFixed(5)}
          </div>
          ${thumbsHtml}
        </div>
      `;
 
      L.marker(draftLatLng)
        .addTo(map)
        .bindPopup(popupHtml)
        .openPopup();
 
      if (draftMarker) {
        map.removeLayer(draftMarker);
        draftMarker = null;
      }
      draftLatLng = null;
 
      notesEl.value = "";
      selectedImageDataUrls = [];
      resetPreviews();

      setStatus("Report saved ‚úÖ Click the map to start a new draft location.", "ok");
    });

     
    clearBtn.addEventListener("click", () => {
      if (draftMarker) {
        map.removeLayer(draftMarker);
        draftMarker = null;
      }
      draftLatLng = null;

      notesEl.value = "";
      selectedImageDataUrls = [];
      resetPreviews();

      setStatus("Draft cleared. Click the map to choose a new draft location.", "");
    });

    function setStatus(text, tone) {
      statusEl.textContent = text;
      statusEl.classList.remove("ok", "bad");
      if (tone === "ok") statusEl.classList.add("ok");
      if (tone === "bad") statusEl.classList.add("bad");
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
 
    resetPreviews();
  </script>
</body>
</html>
